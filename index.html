<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    
    <title>Visor TiQAL</title>
    <link rel="stylesheet" href="style.css">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
</head>
<body>
    <header id="main-header">
        <div class="brand">Visor TiQAL</div>
        <div class="km-wrapper">
            <div class="km-box label-box">PK</div>
            <div class="km-box input-box">
                <input type="text" id="kmInput" value="ESPERANDO ARCHIVO..." title="Presiona Enter para buscar">
            </div>
        </div>
        <div class="header-tools">
            <button class="btn-load" onclick="document.getElementById('fileInput').click()">üìÅ SUBIR DATA TiQAL</button>
        </div>
        <input type="file" id="fileInput" style="display:none" accept=".TiQAL">
    </header>

    <div id="app-container">
        <aside id="sidebar">
            <button class="tab-btn active" onclick="changeLayout('layout-seccion')">üìê<br><span>SECCI√ìN</span></button>
            <button class="tab-btn" onclick="changeLayout('layout-planta')">üó∫Ô∏è<br><span>PLANTA</span></button>
            <button class="tab-btn" onclick="changeLayout('layout-perfil')">üìâ<br><span>PERFIL</span></button>
            
            <div class="separator"></div>
            
            <button class="tab-btn" onclick="changeLayout('layout-multi')">üî≤<br><span>MIXTO</span></button>
            
            <div style="flex-grow: 1;"></div> 

            <button class="tab-btn btn-settings" onclick="toggleSettings()">
                ‚öôÔ∏è<br><span>AJUSTES</span>
            </button>
        </aside>

        <main id="main-dashboard" class="layout-seccion">
            
            <section class="panel" id="panel-planta">
                <header>VISTA DE PLANTA</header>
                <div class="canvas-wrapper">
                    <canvas id="canvasPlanta"></canvas>
                    <div class="panel-controls">
                        <button class="btn-reset-mini" onclick="resetView('planta')" title="Centrar Planta">‚ü≤</button>
                    </div>
                </div>
            </section>

            <section class="panel" id="panel-perfil">
                <header>VISTA DE PERFIL LONGITUDINAL</header>
                <div class="canvas-wrapper">
                    <canvas id="canvasPerfil"></canvas>
                    <div class="panel-controls">
                        <button class="btn-reset-mini" onclick="resetView('perfil')" title="Centrar Perfil">‚ü≤</button>
                    </div>
                </div>
            </section>

            <section class="panel" id="panel-seccion">
                <header>VISTA DE SECCI√ìN TRANSVERSAL</header>
                <div id="canvasContainer" class="canvas-wrapper">
                    <canvas id="visorCanvas"></canvas>
                    
                    <div id="hud" style="display: none;">
                        Elevaci√≥n (Z): <span id="hudY">0.00</span> m<br>
                        Desfase: <span id="hudX">0.00</span> m
                    </div>
                    
                    <div class="panel-controls">
                        <button class="btn-reset-mini" onclick="resetView('seccion')" title="Centrar Secci√≥n">‚ü≤</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <footer id="main-footer">
        <div class="slider-wrapper">
            <input type="range" id="stationSlider" min="0" max="0" value="0">
            <div class="mobile-safe-area"></div>
        </div>
    </footer>

    <div id="settingsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content settings-box">
            <header class="modal-header">
                <div class="header-title">
                    <span>‚öôÔ∏è CONFIGURACI√ìN</span>
                </div>
                <button class="btn-close" onclick="toggleSettings()">√ó</button>
            </header>
            
            <div class="modal-body-layout">
                <aside class="settings-sidebar">
                    <button class="setting-tab active" onclick="openTab('tab-general')">General</button>
                    <button class="setting-tab" onclick="openTab('tab-planta')">Planta</button>
                    <button class="setting-tab" onclick="openTab('tab-perfil')">Perfil</button>
                    <button class="setting-tab" onclick="openTab('tab-seccion')">Secci√≥n</button>
                </aside>

                <main class="settings-main">
                    <div id="tab-general" class="tab-content active">
                        <div class="setting-group">
                            <label>Apariencia</label>
                            <div class="setting-row">
                                <span>Modo D√≠a / Noche</span>
                                <label class="switch">
                                    <input type="checkbox" id="chkTheme" onchange="toggleTheme(this)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>Textos Globales</label>
                            <div class="setting-row">
                                <span>Escala de Texto</span>
                                <input type="number" id="cfgTextScale" value="1.0" step="0.1" min="0.5" max="5.0" class="input-number">
                            </div>
                        </div>
                    </div>

                    <div id="tab-planta" class="tab-content">
                        <div class="setting-group">
                            <label>Etiquetado (Kilometraje)</label>
                            <div class="setting-row">
                                <span>Mostrar Textos</span>
                                <input type="checkbox" id="chkPlantaLabels" checked>
                            </div>
                            <div class="setting-row">
                                <span>Mostrar Ticks (Rayitas)</span> <input type="checkbox" id="chkPlantaTicks" checked>
                            </div>
                            <div class="setting-row">
                                <span>Intervalo Texto (Mayores)</span>
                                <input type="number" id="cfgPlantaMajor" value="1000" step="100" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Intervalo Ticks (Menores)</span>
                                <input type="number" id="cfgPlantaMinor" value="100" step="50" class="input-number">
                            </div>
                        </div>

                        <div class="setting-group">
                            <label>Grilla y Coordenadas</label>
                            <div class="setting-row">
                                <span>Intervalo General (m)</span>
                                <input type="number" id="cfgGridPlanta" value="200" step="50" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Intervalo Miniatura (m)</span>
                                <input type="number" id="cfgGridPlantaMulti" value="500" step="100" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Mostrar Grilla</span>
                                <input type="checkbox" id="chkShowGridPlanta" checked>
                            </div>
                        </div>

                        <div class="setting-group">
                            <label>Gestor de Elementos</label>
                            <div id="layers-planta-container">
                                </div>
                        </div>
                    </div>

                    <div id="tab-perfil" class="tab-content">
                        <div class="setting-group">
                            <label>Visualizaci√≥n</label>
                            <div class="setting-row">
                                <span>Exageraci√≥n Vertical</span>
                                <select id="cfgExajPerfil" class="input-select">
                                    <option value="1">1x (Real)</option>
                                    <option value="5">5x</option>
                                    <option value="10" selected>10x (Standard)</option>
                                    <option value="20">20x</option>
                                </select>
                            </div>
                            
                            <div class="setting-row">
                                <span>Seguir a (Punto Rojo)</span>
                                <select id="cfgTargetPerfil" class="input-select">
                                    <option value="auto">Autom√°tico</option>
                                    </select>
                            </div>
                        </div>

                        <div class="setting-group">
                            <label>Grillas</label>
                            <div class="setting-row">
                                <span>Intervalo PK (Gral)</span>
                                <input type="number" id="cfgGridPerfilK" value="500" step="50" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Intervalo PK (Mini)</span>
                                <input type="number" id="cfgGridPerfilKMulti" value="1000" step="100" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Intervalo Cota (Gral)</span>
                                <input type="number" id="cfgGridPerfilZ" value="10" step="1" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Intervalo Cota (Mini)</span>
                                <input type="number" id="cfgGridPerfilZMulti" value="50" step="5" class="input-number">
                            </div>
                        </div>

                        <div class="setting-group">
                            <label>Gestor de Elementos</label>
                            <div id="layers-perfil-container">
                                </div>
                        </div>
                    </div>

                    <div id="tab-seccion" class="tab-content">
                        <div class="setting-group">
                            <label>Grilla Transversal</label>
                            <div class="setting-row">
                                <span>Intervalo Desfase (X)</span>
                                <input type="number" id="cfgGridSeccionX" value="5" step="1" class="input-number">
                            </div>
                            <div class="setting-row">
                                <span>Intervalo Elevaci√≥n (Y)</span>
                                <input type="number" id="cfgGridSeccionY" value="5" step="1" class="input-number">
                            </div>
                        </div>

                        <div class="setting-group">
                            <label>Gestor de Elementos</label>
                            <div id="layers-seccion-container">
                                </div>
                        </div>
                    </div>
                </main>
            </div>
            
            <footer class="modal-footer">
                <button class="btn-primary" onclick="applySettingsAndClose()">Guardar y Cerrar</button>
            </footer>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log("SW registrado", reg.scope))
                    .catch(err => console.warn("Error al registrar SW", err));
            });
        }
    </script>

    <script src="js/state.js"></script>
    <script src="js/seccion.js"></script>
    <script src="js/planta.js"></script>
    <script src="js/perfil.js"></script>
    <script src="js/main.js"></script>
</body>
</html>